# Select and Speak Chrome拡張 仕様書

## 1. 概要

- Webページ上のテキストをユーザーがドラッグして選択し、マウスボタンを離したタイミングで、その選択テキストを音声読み上げするシンプルなChrome拡張。
- 読み上げ速度を 0.5 倍〜 3.0 倍の範囲で変更できるシークバーを提供する。
- 拡張機能全体の ON / OFF を切り替えるスイッチを提供し、OFF時は一切読み上げを行わない。

## 2. 対象環境

- 対象ブラウザ: Google Chrome 最新版
- マニフェストバージョン: Manifest V3

## 3. 機能要件

### 3.1 テキスト選択検知・読み上げ

- 対象: 一般的なウェブページ上のテキストノード
- 動作トリガー:
  - ユーザーがマウスドラッグでテキストを選択し、マウスボタンを離した (`mouseup`) タイミング。
- 動作仕様:
  - 選択範囲の文字列を取得する。
  - 空文字列、空白のみ、改行のみなど意味のない選択の場合は読み上げを行わない。
  - 拡張の ON/OFF スイッチが「ON」の場合のみ読み上げを実行する。
  - 読み上げには Chrome の音声読み上げ機能（例: `chrome.tts` API）あるいは Web Speech API を利用する。
  - すでに読み上げ中に新しい選択がされた場合は、現在の読み上げを停止し、新しいテキストの読み上げを開始する。

### 3.2 読み上げ速度変更（シークバー）

- UI要素: ポップアップ画面にシークバー（レンジ入力）を配置する。
- 設定範囲:
  - 最小: 0.5 倍
  - 最大: 3.0 倍
  - デフォルト値: 1.0 倍
  - ステップ: 0.1 程度（実装時に調整可）
- 動作仕様:
  - シークバーの位置を変更すると、読み上げ速度パラメータが即時に更新される。
  - 更新された読み上げ速度は、次回以降の読み上げから適用される。
  - 現在設定中の速度を数値ラベル（例: `1.2x`）で表示する。
  - 読み上げ速度の値は `chrome.storage.sync` などに保存し、ブラウザ再起動後も復元される。

### 3.3 拡張 ON/OFF スイッチ

- UI要素: ポップアップ画面に ON/OFF スイッチ（トグル）を配置する。
- 状態:
  - ON: テキスト選択時に読み上げを行う。
  - OFF: テキスト選択時も読み上げを一切行わない。
- 動作仕様:
  - スイッチの状態変更は即時に反映される。
  - スイッチの状態は `chrome.storage.sync` 等に保存し、ブラウザ再起動後も維持される。

## 4. 画面仕様（ポップアップ）

- 表示箇所: Chrome ツールバーの拡張アイコンをクリックしたときに表示されるポップアップ。
- 構成要素（縦方向に配置）:
  1. タイトルエリア
     - 文言例: `Select and Speak`
  2. ON/OFF スイッチ
     - ラベル例: `有効化`
     - 状態表示: `ON` / `OFF`（トグルスイッチ）
  3. 読み上げ速度シークバー
     - ラベル例: `読み上げ速度`
     - シークバー（0.5〜3.0）
     - 現在値表示: `1.0x` のような形でシークバー近くに表示

※ 本仕様では、その他ボタン（テスト再生ボタンなど）は持たないものとする。

## 5. データ・設定

- 保持する設定項目:
  - `enabled`: 拡張の有効/無効状態（真偽値）
  - `rate`: 読み上げ速度（数値、0.5〜3.0）
- 永続化:
  - Chrome 拡張のストレージ機能（`chrome.storage.sync` もしくは `chrome.storage.local`）を利用する。
  - 初回インストール時は `enabled = true`, `rate = 1.0` を初期値とする。

## 6. 権限・マニフェスト

### 6.1 必要権限（想定）

- `"tts"`: 音声読み上げ機能を利用するため。
- `"storage"`: 読み上げ速度・ON/OFF 状態を保存するため。
- `"activeTab"` または `content_scripts` + `"host_permissions"`:
  - Webページ上のテキスト選択状態を取得するため。

### 6.2 マニフェストの主な構成（概要）

- `manifest_version`: 3
- `name`: "Select and Speak"
- `action`:
  - `default_popup`: ポップアップ HTML ファイル
  - `default_icon`: 拡張アイコン
- `permissions`:
  - `tts`
  - `storage`
  - `activeTab`（または `scripting` と host permissions）
- `content_scripts`（または `scripting` 経由で注入）:
  - 対象URL: 一般的な Web ページ（`https://*/*`, `http://*/*` など）
  - 役割: テキスト選択の検知と選択文字列の取得

## 7. イベントフロー（簡易）

### 7.1 テキスト選択 → 読み上げ

1. ユーザーが Web ページ上のテキストをドラッグして選択する。
2. マウスボタンを離したタイミングで `mouseup` イベントを検知する（コンテントスクリプト）。
3. 現在の選択範囲からテキストを取得する。
4. 拡張の設定（`enabled` フラグ）と読み上げ速度（`rate`）をストレージから取得する。
5. `enabled === true` かつ テキストが空でなければ、読み上げ API を呼び出す。

### 7.2 ON/OFF 切り替え

1. ユーザーがポップアップ内の ON/OFF スイッチを操作する。
2. 新しい状態（ON / OFF）をストレージに保存する。
3. 保存された状態は以後のテキスト選択時の読み上げ可否に利用される。

### 7.3 読み上げ速度変更

1. ユーザーがポップアップ内のシークバーを操作する。
2. シークバーの値をリアルタイムに数値ラベルへ反映する（例: `1.5x`）。
3. 新しい速度をストレージに保存する。
4. 次回以降の読み上げではこの速度が利用される。

## 8. 非機能要件（簡易）

- パフォーマンス:
  - コンテントスクリプトは必要最低限の処理とし、ページの表示・操作を遅延させない。
- ユーザビリティ:
  - ポップアップはシンプルで直感的なUIとし、1〜2クリックで設定を変更できる。
- プライバシー:
  - テキスト内容や設定情報を外部サーバーへ送信しない（全てローカルまたはブラウザ内で完結）。

